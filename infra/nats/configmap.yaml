apiVersion: v1
kind: ConfigMap
metadata:
  name: nats-config
  namespace: nats
data:
  entrypoint.sh: |
    #!/bin/sh
    set -e
    sed -e "s/\${NATS_USER}/${NATS_USER}/g" \
        -e "s/\${NATS_PASSWORD}/${NATS_PASSWORD}/g" \
        -e "s/\${POD_NAME}/${POD_NAME}/g" \
        /etc/nats-config/nats.conf.tpl > /tmp/nats.conf
    exec nats-server --config /tmp/nats.conf
  nats.conf.tpl: |
    # Server configuration
    server_name: ${POD_NAME}
    port: 4222
    
    # HTTP monitoring port
    http_port: 8222
    
    # JetStream configuration
    jetstream {
      store_dir: /data/jetstream
      
      # Maximum memory and storage
      max_memory_store: 1Gi
      max_file_store: 9Gi
      
      # Domain (optional, for multi-cluster setups)
      # domain: homelab
    }
    
    # Clustering (for future multi-instance setup)
    # cluster {
    #   name: homelab-cluster
    #   port: 6222
    #   routes: [
    #     nats://nats-0.nats.nats.svc.cluster.local:6222
    #     nats://nats-1.nats.nats.svc.cluster.local:6222
    #     nats://nats-2.nats.nats.svc.cluster.local:6222
    #   ]
    # }
    
    # System account for server monitoring
    system_account: SYS
    
    accounts: {
      SYS: {
        users: [
          {user: "${NATS_USER}", password: "${NATS_PASSWORD}"}
        ]
      }
    }
    
    # Logging
    logtime: true
    log_file: "/dev/stdout"
    
    # Limits
    max_connections: 1000
    max_control_line: 4096
    max_payload: 1048576
    max_pending: 67108864
    write_deadline: "10s"

